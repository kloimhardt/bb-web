<!--
     Excerpted from "Web Development with Clojure, Third Edition",
     published by The Pragmatic Bookshelf.
     Copyrights apply to this code. It may not be used to create training material,
     courses, books, articles, and the like. Contact us if you are in doubt.
     We make no guarantees that this code is fit for any purpose.
     Visit http://www.pragmaticprogrammer.com/titles/dswdcloj3 for more book information.
     ---
     small changes made for use with https://github.com/kloimhardt/bb-web
     zip archive retrieved from the "Resources" section of
     https://pragprog.com/titles/dswdcloj3/web-development-with-clojure-third-edition/
     file: guestbook-reagent/src/cljs/guestbook/core.cljs
-->

<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>bb_web</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.0/css/bulma.min.css">
</head>

<body>
<div id="cljs-app">

(require '[reagent.core :as r]
         '[goog.object :as go])

;
(defn message-list [messages]
  (println messages)
  [:ul.messages
   (for [{:keys [timestamp message name]} @messages]
     ^{:key timestamp}
     [:li
      [:time timestamp]
      [:p message]
      [:p " - " name]])])
;

;
(defn send-message! [fields messages]
  (do
    (swap! messages conj (assoc @fields :timestamp (bb-web/timestamp)))
    (reset! fields nil)))
;

;
(defn message-form [messages]
  (let [fields (r/cursor bb-web/state [:fields])]
    (fn [messages]
      [:div
       [:div.field
        [:label.label {:for :name} "Name"]
        [:input.input
         {:type :text
          :name :name
          :on-change (fn [e] (swap! fields assoc :name
                                    (-> e (go/get "target") (go/get "value"))))
          :value (:name @fields)}]]
       [:div.field
        [:label.label {:for :message} "Message"]
        [:textarea.textarea
         {:name :message
          :value (:message @fields)
          :on-change (fn [e] (swap! fields assoc :message
                                    (-> e (go/get "target") (go/get "value"))))}]]
       [:input.button.is-primary
        {:type :submit
         :on-click (fn [_] (send-message! fields messages))
         :value "comment"}]])))

(defn home []
  (let [messages (r/cursor bb-web/state [:messages])]
    (fn []
      [:div.content>div.columns.is-centered>div.column.is-two-thirds
       [:div.columns>div.column
        [:h3 "Messages"]
        [message-list messages]]
       [:div.columns>div.column
        [message-form messages]]])))
;
</div>

<script src="js/bb_web/bb_web.js"></script>
</body>

</html>
